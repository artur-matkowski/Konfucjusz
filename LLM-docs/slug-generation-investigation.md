# Slug Generation Investigation

## Problem Statement
Events created through `/eventManagement` admin page do not get slugs generated, resulting in no "Enlist Link" appearing in the `/events/edit/{id}` page.

## CRITICAL FINDING (2026-01-02 19:45)

**User was clicking "Save Event" in EventEdit.razor (`/events/edit/{id}`), NOT in EventManagement.razor!**

The actual user workflow:
1. Admin creates event in `/eventManagement` (via "Add new event" button or manual creation)
2. Admin navigates to `/events/edit/{eventId}` to edit event details
3. Admin clicks "Save Event" button in EventEdit page
4. EventEdit.SaveEventAsync() does NOT call slug generation → **BUG FOUND**

**Root Cause:** EventEdit.razor SaveEventAsync() method only calls:
```csharp
Db.events.Update(CurrentEvent);
await Db.SaveChangesAsync();
StatusMessage = "Event updated successfully.";
```

Missing: Call to `EventSvc.EnsureSlugAsync(CurrentEvent)` after save.

**Fix Applied:** Added slug generation to EventEdit.SaveEventAsync() at line ~420.

## System Architecture Analysis

### Event Creation Flow

#### Path 1: Admin Event Management (`/eventManagement`)
```
User clicks "Add new event"
  → AddNewEventAsync() in EventManagement.razor
    → EventSvc.CreateEventWithSlugAsync(newEvent)
      → Event saved to DB (ID assigned by database)
      → CreationTimestamp set by database (default: now())
      → Slug should be generated using GenerateSlug()
      → Slug should be saved back to DB
```

#### Path 2: Event Edit Page (`/events/edit/{id}`)
```
User clicks "Save Event"
  → SaveEventAsync() in EventEdit.razor
    → Db.events.Update(CurrentEvent)
    → Db.SaveChangesAsync()
    → No slug generation called
```

### Database Schema

```sql
Table: events
- id: integer (PK, generated by default as identity)
- creation_timestamp: timestamp with time zone (default: now(), NOT NULL)
- slug: character varying(64) (nullable, unique index)
- ... other fields
```

**Key Finding:** `creation_timestamp` has a database-level default of `now()`, which is applied when INSERT happens.

### EF Core Configuration

From `ApplicationDbContext.cs`:
```csharp
modelBuilder.Entity<Event>(eb =>
{
    eb.Property(e => e.CreationTimestamp)
        .HasColumnName("creation_timestamp")
        .HasDefaultValueSql("now()")
        .ValueGeneratedOnAdd();  // ← IMPORTANT!
});
```

**Critical Insight:** `.ValueGeneratedOnAdd()` tells EF Core:
1. Don't send this value in INSERT
2. Read it back after INSERT
3. The database will generate the value

### Slug Generation Logic

From `Event.cs`:
```csharp
public static string GenerateSlug(int eventId, DateTime creationTimestamp, string secret)
{
    var payload = $"{eventId}|{creationTimestamp:O}";
    using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(secret));
    var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(payload));
    
    return Convert.ToBase64String(hash)
        .Replace('+', '-')
        .Replace('/', '_')
        .Replace("=", "")
        .Substring(0, 16);
}
```

**Requirements for slug generation:**
1. Event must have ID (assigned by database)
2. Event must have CreationTimestamp (assigned by database)
3. Secret must be available (from configuration)

## Current Implementation

### EventService.CreateEventWithSlugAsync()

```csharp
public async Task<Event> CreateEventWithSlugAsync(Event newEvent, int? creatorUserId = null)
{
    _logger.LogInformation("=== CreateEventWithSlugAsync START ===");
    _logger.LogInformation("Event Title: {Title}", newEvent.Title);
    
    _db.events.Add(newEvent);
    await _db.SaveChangesAsync();
    
    _logger.LogInformation("Event saved. ID: {EventId}, CreationTimestamp: {CreationTimestamp}", 
        newEvent.Id, newEvent.CreationTimestamp);

    if (string.IsNullOrEmpty(newEvent.Slug))
    {
        _logger.LogInformation("Slug is empty, generating...");
        
        if (newEvent.CreationTimestamp == default)
        {
            newEvent.CreationTimestamp = DateTime.UtcNow;
            _logger.LogWarning("CreationTimestamp was default, set to UtcNow");
        }

        newEvent.Slug = Event.GenerateSlug(newEvent.Id, newEvent.CreationTimestamp, _slugSecret);
        _logger.LogInformation("Generated slug: {Slug}", newEvent.Slug);
        
        _db.events.Update(newEvent);
        await _db.SaveChangesAsync();
        _logger.LogInformation("Slug saved to database");
    }
    
    _logger.LogInformation("=== CreateEventWithSlugAsync END ===");
    return newEvent;
}
```

## Database Investigation Results

```sql
SELECT id, title, creation_timestamp, slug FROM events ORDER BY id;

 id |   title   |      creation_timestamp       |       slug       
----+-----------+-------------------------------+------------------
  1 | New Event | 2026-01-02 18:04:42.841007+00 | 3bJ9XPOD6wpK6Q8J
  2 | New Event | 2026-01-02 18:18:24.724849+00 | QzXBuQmOuTbtAhSz
  3 | New Event | 2026-01-02 18:28:47.544487+00 | 9PqYEcHUJMNn6O1Q
  4 | New Event | 2026-01-02 18:37:39.078256+00 | (empty string)
```

**Finding:** 
- Events 1-3 have valid slugs (likely backfilled by Program.cs startup code)
- Event 4 has empty slug despite having valid creation_timestamp

## Hypotheses

### Hypothesis 1: Logging Not Working
**Test:** No logs appear in docker logs for CreateEventWithSlugAsync
**Status:** CONFIRMED - No logs appear even though code should execute

### Hypothesis 2: Old Code Running in Container
**Test:** Container might be running old compiled code
**Status:** NEEDS VERIFICATION - Container is up 12 minutes but may not have latest code

### Hypothesis 3: EF Core Not Reading Back CreationTimestamp
**Test:** After SaveChangesAsync(), newEvent.CreationTimestamp might still be default(DateTime)
**Status:** NEEDS VERIFICATION - Could explain slug generation failure

### Hypothesis 4: Blazor Component Caching Issue
**Test:** Blazor might be using cached component code
**Status:** NEEDS VERIFICATION - Browser cache or Blazor assembly cache

### Hypothesis 5: Service Not Registered Correctly
**Test:** EventService constructor might not be called with logger
**Status:** NEEDS VERIFICATION - Would prevent any logging

## Next Steps

1. **Verify deployment:**
   - Check if latest code is actually deployed in container
   - Verify DLL timestamps match build time
   - Check if docker-compose actually rebuilt

2. **Test EF Core behavior:**
   - Create minimal test to check if CreationTimestamp is read back
   - Log exact value of newEvent.CreationTimestamp after first SaveChangesAsync()

3. **Verify service registration:**
   - Add logging to EventService constructor
   - Verify ILogger is actually injected

4. **Check for silent exceptions:**
   - Add try-catch at higher level
   - Check if exceptions are being swallowed

5. **Web research:**
   - EF Core ValueGeneratedOnAdd() behavior with Blazor
   - Postgres now() default with EF Core
   - Blazor Server component lifecycle and DI

## Additional Context

### Program.cs Startup Slug Backfill
```csharp
var eventsWithoutSlug = db.events.Where(e => e.Slug == null || e.Slug == "").ToList();
if (eventsWithoutSlug.Any())
{
    var localSlugSecret = builder.Configuration["SlugSecret"] ?? "default-slug-secret-change-in-production";
    foreach (var ev in eventsWithoutSlug)
    {
        if (ev.CreationTimestamp == default)
        {
            ev.CreationTimestamp = DateTime.UtcNow;
        }
        var payload = $"{ev.Id}|{ev.CreationTimestamp:O}";
        using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(localSlugSecret));
        var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(payload));
        var slug = Convert.ToBase64String(hash)
            .Replace('+', '-')
            .Replace('/', '_')
            .Replace("=", "");
        if (slug.Length > 16) slug = slug.Substring(0, 16);
        ev.Slug = slug;
    }
    db.SaveChanges();
    Console.WriteLine($"Generated slugs for {eventsWithoutSlug.Count} existing events.");
}
```

**Note:** This runs at startup and should catch events without slugs. If event 4 still has no slug, it means:
1. It was created AFTER the last restart
2. The CreateEventWithSlugAsync code didn't run
3. The SaveAsync code in EventManagement didn't run

## Browser Console Investigation Needed

Expected client-side logs:
```
=== CLIENT: AddNewEventAsync START ===
CLIENT: Calling EventSvc.CreateEventWithSlugAsync...
CLIENT: Event created. ID: X, Slug: XXXXX
=== CLIENT: AddNewEventAsync END ===
```

If these don't appear, the button click handler isn't firing or component isn't updated.
