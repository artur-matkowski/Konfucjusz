version: '3.8'

services:
  db:
    container_name: konfucjusz_db
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: konfucjusz_db
      POSTGRES_USER: konfucjusz
      # WARNING: weak dev password. Override via DB_PASSWORD in .env for anything non-trivial.
      POSTGRES_PASSWORD: ${DB_PASSWORD:-konfucjuszpass}
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data

  app:
    container_name: konfucjusz_app
    image: ghcr.io/artur-matkowski/konfucjusz:latest
    restart: unless-stopped
    depends_on:
      - db
    environment:
      # Match Program.cs: "MyConnection"
      ConnectionStrings__MyConnection: >
        Host=db;Port=5432;Database=konfucjusz_db;Username=konfucjusz;Password=${DB_PASSWORD:-konfucjuszpass}
      # Slug secret: MUST override in .env (non-default) before public deployment.
      SlugSecret: ${SLUG_SECRET:-default-slug-secret-change-in-production}
      # ASP.NET Core environment
      ASPNETCORE_ENVIRONMENT: Development
      # SMTP settings for OVH (real mail server). All values should come from .env and NOT be committed.
      Smtp__Host: ${SMTP_HOST}
      Smtp__Port: ${SMTP_PORT:-587}
      Smtp__UseStartTls: "${SMTP_USE_STARTTLS:-true}"
      Smtp__Username: ${SMTP_USERNAME}
      Smtp__Password: ${SMTP_PASSWORD}
      Smtp__From: ${SMTP_FROM}
      # hCaptcha configuration
      Captcha__hCaptcha__SiteKey: ${Captcha__hCaptcha__SiteKey}
      Captcha__hCaptcha__Secret: ${Captcha__hCaptcha__Secret}
    ports:
      - "8080:80"  # host:container
    volumes:
      - recordings-data:/app/wwwroot/recordings

volumes:
  db-data:
  recordings-data:
