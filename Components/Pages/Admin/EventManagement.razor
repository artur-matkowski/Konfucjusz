@page "/eventManagement"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components
@attribute [Authorize(Roles = "Administrator")]
@inject ApplicationDbContext Db
@inject EventService EventSvc
@inject IJSRuntime JS

<h3>Event Management</h3>

@if (!string.IsNullOrEmpty(StatusMessage))
{
    <div class="alert @StatusCssClass alert-dismissible fade show" role="alert">
        @StatusMessage
        <button type="button" class="btn-close" @onclick="() => StatusMessage = null"></button>
    </div>
}

@if (SelectedCount > 0)
{
    <div class="alert alert-info d-flex justify-content-between align-items-center mb-3" role="alert">
        <span><strong>@SelectedCount</strong> event(s) selected</span>
        <div class="d-flex gap-2">
            <button class="btn btn-danger btn-sm" @onclick="PromptBulkDelete">
                <i class="bi bi-trash"></i> Delete Selected (@SelectedCount)
            </button>
            <button class="btn btn-secondary btn-sm" @onclick="ClearSelection">
                Clear Selection
            </button>
        </div>
    </div>
}

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th style="width:40px">
                    <input type="checkbox" @bind="selectAll" @bind:after="ToggleSelectAll" title="Select all" />
                </th>
                <th style="width:60px">Id</th>
                <th style="width:160px">Created</th>
                <th>Title</th>
                <th>Description</th>
                <th style="width:150px">Enlist Start</th>
                <th style="width:150px">Enlist End</th>
                <th style="width:150px">Event Start</th>
                <th style="width:150px">Event End</th>
                <th style="width:100px">Searchable</th>
                <th style="width:110px">Anon Enlist</th>
                <th style="width:120px" title="When enabled, anyone with the stream link can listen without logging in">Public Stream</th>
                <th style="width:150px">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (Event item in Events)
            {
                <tr>
                    <td>
                        <input type="checkbox" @bind="selectedEventIds[item.Id]" />
                    </td>
                    <td class="text-muted">@item.Id</td>
                    <td class="text-nowrap">@(item.CreationTimestamp.ToString("g"))</td>

                    @if (EditedIds.Contains(item.Id))
                    {
                        <td><input type="text" class="form-control form-control-sm" @bind="item.Title" /></td>
                        <td><textarea class="form-control form-control-sm" rows="2" @bind="item.Description"></textarea></td>
                        <td><input type="datetime-local" class="form-control form-control-sm" @bind="item.EnlistingStartDate" /></td>
                        <td><input type="datetime-local" class="form-control form-control-sm" @bind="item.EnlistingEndDate" /></td>
                        <td><input type="datetime-local" class="form-control form-control-sm" @bind="item.EventStartDate" /></td>
                        <td><input type="datetime-local" class="form-control form-control-sm" @bind="item.EventEndDate" /></td>
                        <td class="text-center"><input type="checkbox" @bind="item.Searchable" /></td>
                        <td class="text-center"><input type="checkbox" @bind="item.AllowedAnonymousEnlisting" /></td>
                        <td class="text-center"><input type="checkbox" @bind="item.AllowAnonymousStreaming" /></td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary" @onclick="() => SaveAsync(item)">Save</button>
                                <button class="btn btn-sm btn-secondary" @onclick="() => CancelEdit(item.Id)">Cancel</button>
                            </div>
                        </td>
                    }
                    else
                    {
                        <td>@item.Title</td>
                        <td style="max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="@item.Description">@item.Description</td>
                        <td class="text-nowrap">@(item.EnlistingStartDate.ToString("g"))</td>
                        <td class="text-nowrap">@(item.EnlistingEndDate.ToString("g"))</td>
                        <td class="text-nowrap">@(item.EventStartDate.ToString("g"))</td>
                        <td class="text-nowrap">@(item.EventEndDate.ToString("g"))</td>
                        <td>
                            @if (item.Searchable)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        </td>
                        <td>
                            @if (item.AllowedAnonymousEnlisting)
                            {
                                <span class="badge bg-info">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        </td>
                        <td>
                            @if (item.AllowAnonymousStreaming)
                            {
                                <span class="badge bg-info">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => EditedIds.Add(item.Id)">Edit</button>
                            </div>
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="mt-3">
    <button class="btn btn-primary" @onclick="AddNewEventAsync">Add new event</button>
</div>

@if (showBulkDeleteDialog)
{
    <div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1050;display:flex;align-items:center;justify-content:center;">
        <div class="card" style="width:500px;max-width:95%;">
            <div class="card-body">
                <h5 class="card-title text-danger">Confirm Deletion</h5>
                <p class="mb-2">
                    You are about to permanently delete <strong>@SelectedCount event(s)</strong>.
                </p>
                <p class="mb-2">This will also delete:</p>
                <ul class="mb-3">
                    <li>All event organizers</li>
                    <li>All event participants</li>
                    <li>All event recordings (database records)</li>
                    <li>All recording files from disk</li>
                </ul>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                
                <div class="d-flex justify-content-end gap-2 mt-3">
                    <button class="btn btn-secondary" @onclick="CancelBulkDelete">Cancel</button>
                    <button class="btn btn-danger" @onclick="ConfirmBulkDeleteAsync">
                        Delete @SelectedCount Event(s)
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Event> Events { get; set; } = new();
    private List<int> EditedIds { get; set; } = new();
    private string? StatusMessage { get; set; }
    private string StatusCssClass { get; set; } = "alert-info";

    // Bulk selection state
    private Dictionary<int, bool> selectedEventIds = new();
    private bool selectAll = false;

    // Computed properties
    private int SelectedCount => selectedEventIds.Count(kvp => kvp.Value);
    private List<int> GetSelectedEventIds() => selectedEventIds.Where(kvp => kvp.Value).Select(kvp => kvp.Key).ToList();

    // Dialog state
    private bool showBulkDeleteDialog = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadEventsAsync();
    }

    private async Task LoadEventsAsync()
    {
        // Use AsNoTracking to prevent auto-save behavior
        // Events will only be saved when SaveAsync is explicitly called
        Events = await Db.events.AsNoTracking().OrderBy(e => e.Id).ToListAsync();
        
        // Initialize selection state for new events
        foreach (var evt in Events)
        {
            if (!selectedEventIds.ContainsKey(evt.Id))
            {
                selectedEventIds[evt.Id] = false;
            }
        }
    }

    private async Task AddNewEventAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("console.log", "=== CLIENT: AddNewEventAsync START ===");
            
            var now = DateTime.UtcNow;
            var newEvent = new Event
            {
                Title = "New Event",
                Description = "Event description",
                EventStartDate = now.AddDays(7),
                EventEndDate = now.AddDays(7).AddHours(2),
                EnlistingStartDate = now,
                EnlistingEndDate = now.AddDays(6),
                AllowedAnonymousEnlisting = false,
                AllowAnonymousStreaming = false,
                Searchable = true
            };

            await JS.InvokeVoidAsync("console.log", "CLIENT: Calling EventSvc.CreateEventWithSlugAsync...");
            
            // Use EventService to create event with slug generation
            var createdEvent = await EventSvc.CreateEventWithSlugAsync(newEvent);
            
            await JS.InvokeVoidAsync("console.log", $"CLIENT: Event created. ID: {createdEvent.Id}, Slug: {createdEvent.Slug ?? "(null)"}");
            
            await LoadEventsAsync();
            
            StatusMessage = $"New event created with ID: {createdEvent.Id}, Slug: {createdEvent.Slug ?? "(none)"}";
            StatusCssClass = "alert-success";
            
            await JS.InvokeVoidAsync("console.log", "=== CLIENT: AddNewEventAsync END ===");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SERVER ERROR in AddNewEventAsync: {ex}");
            StatusMessage = $"Error creating event: {ex.Message}";
            StatusCssClass = "alert-danger";
            await JS.InvokeVoidAsync("console.error", $"CLIENT ERROR in AddNewEventAsync: {ex.Message}");
        }
    }

    private async Task SaveAsync(Event evt)
    {
        try
        {
            await JS.InvokeVoidAsync("console.log", $"=== CLIENT: SaveAsync START === Event ID: {evt.Id}, Current Slug: {evt.Slug ?? "(null)"}");
            
            // Since we're using AsNoTracking, we need to attach and mark as modified
            Db.events.Attach(evt);
            Db.Entry(evt).State = EntityState.Modified;
            await Db.SaveChangesAsync();
            
            await JS.InvokeVoidAsync("console.log", "CLIENT: Event updated in DB, calling EnsureSlugAsync...");
            
            // Ensure slug is generated after save (in case it was missing)
            var slugGenerated = await EventSvc.EnsureSlugAsync(evt);
            
            await JS.InvokeVoidAsync("console.log", $"CLIENT: EnsureSlugAsync returned: {slugGenerated}, Final Slug: {evt.Slug ?? "(null)"}");
            
            EditedIds.RemoveAll(x => x == evt.Id);
            await LoadEventsAsync();
            
            StatusMessage = $"Event '{evt.Title}' saved successfully. Slug: {evt.Slug ?? "(none)"}";
            StatusCssClass = "alert-success";
            
            await JS.InvokeVoidAsync("console.log", "=== CLIENT: SaveAsync END ===");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SERVER ERROR in SaveAsync: {ex}");
            StatusMessage = $"Error saving event: {ex.Message}";
            StatusCssClass = "alert-danger";
            await JS.InvokeVoidAsync("console.error", $"CLIENT ERROR in SaveAsync: {ex.Message}");
        }
    }

    private void CancelEdit(int id)
    {
        EditedIds.RemoveAll(x => x == id);
        // Reload to discard changes
        _ = LoadEventsAsync();
    }

    // Bulk selection methods
    private void ToggleSelectAll()
    {
        foreach (var evt in Events)
        {
            selectedEventIds[evt.Id] = selectAll;
        }
    }

    private void ClearSelection()
    {
        foreach (var key in selectedEventIds.Keys.ToList())
        {
            selectedEventIds[key] = false;
        }
        selectAll = false;
    }

    private void PromptBulkDelete()
    {
        if (SelectedCount == 0) return;
        showBulkDeleteDialog = true;
    }

    private void CancelBulkDelete()
    {
        showBulkDeleteDialog = false;
    }

    private async Task ConfirmBulkDeleteAsync()
    {
        try
        {
            var idsToDelete = GetSelectedEventIds();
            
            if (idsToDelete.Count == 0)
            {
                StatusMessage = "No events selected for deletion.";
                StatusCssClass = "alert-warning";
                return;
            }

            await JS.InvokeVoidAsync("console.log", $"=== CLIENT: Bulk delete START === Deleting {idsToDelete.Count} event(s)");

            var (successCount, failureCount, totalFiles, message) = 
                await EventSvc.DeleteMultipleEventsWithCleanupAsync(idsToDelete);

            await JS.InvokeVoidAsync("console.log", $"CLIENT: Bulk delete completed. Success: {successCount}, Failed: {failureCount}, Files: {totalFiles}");

            showBulkDeleteDialog = false;
            ClearSelection();
            await LoadEventsAsync();

            StatusMessage = message;
            StatusCssClass = failureCount > 0 ? "alert-warning" : "alert-success";

            await JS.InvokeVoidAsync("console.log", "=== CLIENT: Bulk delete END ===");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SERVER ERROR in ConfirmBulkDeleteAsync: {ex}");
            StatusMessage = $"Error during bulk deletion: {ex.Message}";
            StatusCssClass = "alert-danger";
            await JS.InvokeVoidAsync("console.error", $"CLIENT ERROR in ConfirmBulkDeleteAsync: {ex.Message}");
        }
    }
}
