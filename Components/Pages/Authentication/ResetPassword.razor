@page "/reset-password"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Identity
@inject ApplicationDbContext Db
@inject NavigationManager Nav

<div class="row">
    <div class="col-lg-5 offset-lg-3 pt-4 pb-4 border">
        <h3>Reset password</h3>

        @if (!string.IsNullOrEmpty(StatusMessage))
        {
            <div class="alert @StatusCss" role="alert">@StatusMessage</div>
        }

        @if (IsTokenValid)
        {
            <form @onsubmit="HandleReset">
                <div class="mb-3">
                    <label>New password</label>
                    <input type="password" class="form-control" @bind="NewPassword" minlength="6" required />
                </div>
                <div class="mb-3">
                    <label>Confirm new password</label>
                    <input type="password" class="form-control" @bind="ConfirmPassword" minlength="6" required />
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">Set new password</button>
                </div>
            </form>
        }
        else
        {
            <p>Invalid or expired reset link. Please request a new one.</p>
        }
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? token { get; set; }

    private bool IsTokenValid { get; set; }
    private int TokenUserId { get; set; }
    private string? TokenEmail { get; set; }

    private string? NewPassword { get; set; }
    private string? ConfirmPassword { get; set; }

    private string? StatusMessage { get; set; }
    private string StatusCss { get; set; } = "alert-info";

    protected override void OnInitialized()
    {
        if (string.IsNullOrEmpty(token))
        {
            IsTokenValid = false;
            return;
        }

        if (UserAccount.TryParsePasswordResetToken(token, out var uid, out var email, out var expiryUtc))
        {
            if (DateTime.UtcNow <= expiryUtc)
            {
                IsTokenValid = true;
                TokenUserId = uid;
                TokenEmail = email;
                return;
            }
        }

        IsTokenValid = false;
    }

    private async Task HandleReset()
    {
        try
        {
            if (!IsTokenValid)
            {
                StatusMessage = "Invalid or expired token.";
                StatusCss = "alert-danger";
                return;
            }

            if (NewPassword != ConfirmPassword)
            {
                StatusMessage = "Passwords do not match.";
                StatusCss = "alert-danger";
                return;
            }

            var user = await Db.users.FindAsync(TokenUserId);
            if (user == null || !string.Equals(user.userEmail, TokenEmail, StringComparison.OrdinalIgnoreCase))
            {
                StatusMessage = "User not found or email mismatch.";
                StatusCss = "alert-danger";
                return;
            }

            var hasher = new PasswordHasher<UserAccount>();
            user.userPassword = hasher.HashPassword(user, NewPassword!);
            await Db.SaveChangesAsync();

            StatusMessage = "Password has been reset. You can now log in.";
            StatusCss = "alert-success";

            // Optionally navigate to login after short delay
            // Nav.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            StatusMessage = "An error occurred while resetting the password.";
            StatusCss = "alert-danger";
        }
    }
}
