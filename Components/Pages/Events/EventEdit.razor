@page "/events/edit/{EventId:int}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Roles = "Administrator,Organizer")]
@inject EventService EventSvc
@inject ParticipantService ParticipantSvc
@inject AuthenticationStateProvider AuthStateProvider
@inject ApplicationDbContext Db
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject EmailRequest EmailService

<h3>Edit Event</h3>

@if (!CanManageEvent)
{
    <div class="alert alert-danger">You do not have permission to manage this event.</div>
    <a href="/events" class="btn btn-secondary">Back to Events</a>
    return;
}

@if (!string.IsNullOrEmpty(StatusMessage))
{
    <div class="alert @StatusCss" role="alert">@StatusMessage</div>
}

@if (CurrentEvent != null)
{
    <form>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Title</label>
                <input type="text" class="form-control" @bind="CurrentEvent.Title" />
            </div>
            <div class="col-md-6 mb-3">
                <label>Description</label>
                <textarea class="form-control" rows="3" @bind="CurrentEvent.Description"></textarea>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Event Start Date</label>
                <input type="datetime-local" class="form-control" @bind="CurrentEvent.EventStartDate" />
            </div>
            <div class="col-md-6 mb-3">
                <label>Event End Date</label>
                <input type="datetime-local" class="form-control" @bind="CurrentEvent.EventEndDate" />
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Enlisting Start Date</label>
                <input type="datetime-local" class="form-control" @bind="CurrentEvent.EnlistingStartDate" />
            </div>
            <div class="col-md-6 mb-3">
                <label>Enlisting End Date</label>
                <input type="datetime-local" class="form-control" @bind="CurrentEvent.EnlistingEndDate" />
            </div>
        </div>

        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" @bind="CurrentEvent.Searchable" id="searchable" />
                    <label class="form-check-label" for="searchable">Searchable</label>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" @bind="CurrentEvent.AllowedAnonymousEnlisting" id="anonEnlist" />
                    <label class="form-check-label" for="anonEnlist">Allow Anonymous Enlisting</label>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" @bind="CurrentEvent.AllowAnonymousStreaming" id="anonStream" />
                    <label class="form-check-label" for="anonStream">Allow Anonymous Streaming</label>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" @bind="CurrentEvent.EnableWaitlist" id="enableWaitlist" />
                    <label class="form-check-label" for="enableWaitlist">Enable Waitlist</label>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" @bind="CurrentEvent.RequireOrganizerApproval" id="requireApproval" />
                    <label class="form-check-label" for="requireApproval">Require Organizer Approval</label>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <label>Max Participants</label>
                <input type="number" class="form-control" @bind="CurrentEvent.MaxParticipants" placeholder="Unlimited" />
            </div>
        </div>

        <div class="mb-3">
            <label>Consent Text (for anonymous participants)</label>
            <textarea class="form-control" rows="4" @bind="CurrentEvent.ConsentText" placeholder="Enter consent text or terms..."></textarea>
            <small class="form-text text-muted">This will be shown to anonymous users when they enlist.</small>
        </div>

        <div class="mb-3">
            <button type="button" class="btn btn-primary" @onclick="SaveEventAsync">Save Event</button>
            <a href="/events" class="btn btn-secondary">Cancel</a>
            @if (IsAdmin)
            {
                <button type="button" class="btn btn-outline-danger" @onclick="() => PromptDeleteEvent()">Delete Event</button>
            }
        </div>
    </form>

    <hr class="my-4" />

    <h4>Event Organizers</h4>
    
    <div class="mb-3">
        <label>Add Organizer by Email</label>
        <div class="input-group">
            <input type="email" class="form-control" @bind="NewOrganizerEmail" placeholder="user@example.com" />
            <button class="btn btn-outline-primary" @onclick="AddOrganizerAsync">Add</button>
        </div>
    </div>

    <table class="table table-sm">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Organizers == null || !Organizers.Any())
            {
                <tr><td colspan="3" class="text-muted">No organizers assigned.</td></tr>
            }
            else
            {
                @foreach (var org in Organizers)
                {
                    <tr>
                        <td>@org.userName @org.surname</td>
                        <td>@org.userEmail</td>
                        <td>
                            @if (org.Id != CurrentUserId)
                            {
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveOrganizerAsync(org.Id)">Remove</button>
                            }
                            else
                            {
                                <span class="text-muted">(You)</span>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>

    <hr class="my-4" />

    <h4>Enlist Link</h4>
    @if (!string.IsNullOrEmpty(CurrentEvent.Slug))
    {
        var enlistUrl = $"{Nav.BaseUri}e/{CurrentEvent.Slug}/enlist";
        <div class="mb-3">
            <div class="input-group">
                <input type="text" class="form-control" readonly value="@enlistUrl" id="enlistLinkInput" />
                <button class="btn btn-outline-secondary" @onclick="() => CopyToClipboard(enlistUrl)">
                    <i class="bi bi-clipboard"></i> Copy
                </button>
            </div>
            <small class="form-text text-muted">Share this link for people to enlist to your event.</small>
        </div>
    }
    else
    {
        <div class="alert alert-warning">Slug not generated yet. Save the event first.</div>
    }

    <hr class="my-4" />

    <h4>Participants</h4>

    @if (ParticipantCounts != null)
    {
        <div class="mb-3">
            <span class="badge bg-success me-2">Confirmed: @ParticipantCounts.Confirmed</span>
            <span class="badge bg-warning me-2">Waitlisted: @ParticipantCounts.Waitlisted</span>
            <span class="badge bg-info me-2">Pending Email: @ParticipantCounts.PendingEmail</span>
            <span class="badge bg-secondary me-2">Pending Approval: @ParticipantCounts.PendingApproval</span>
            <span class="badge bg-danger me-2">Declined: @ParticipantCounts.Declined</span>
            @if (CurrentEvent.MaxParticipants.HasValue)
            {
                <span class="text-muted">/ Max: @CurrentEvent.MaxParticipants</span>
            }
        </div>
    }

    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link @(ParticipantFilter == null ? "active" : "")" @onclick="() => FilterParticipants(null)" style="cursor:pointer;">All</a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(ParticipantFilter == ParticipantStatus.Confirmed ? "active" : "")" @onclick="() => FilterParticipants(ParticipantStatus.Confirmed)" style="cursor:pointer;">Confirmed</a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(ParticipantFilter == ParticipantStatus.PendingEmail ? "active" : "")" @onclick="() => FilterParticipants(ParticipantStatus.PendingEmail)" style="cursor:pointer;">Pending Email</a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(ParticipantFilter == ParticipantStatus.PendingApproval ? "active" : "")" @onclick="() => FilterParticipants(ParticipantStatus.PendingApproval)" style="cursor:pointer;">Pending Approval</a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(ParticipantFilter == ParticipantStatus.Waitlisted ? "active" : "")" @onclick="() => FilterParticipants(ParticipantStatus.Waitlisted)" style="cursor:pointer;">Waitlisted</a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(ParticipantFilter == ParticipantStatus.Declined ? "active" : "")" @onclick="() => FilterParticipants(ParticipantStatus.Declined)" style="cursor:pointer;">Declined</a>
        </li>
    </ul>

    <table class="table table-sm">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Type</th>
                <th>Status</th>
                <th>Enlisted</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Participants == null || !Participants.Any())
            {
                <tr><td colspan="6" class="text-muted">No participants yet.</td></tr>
            }
            else
            {
                @foreach (var p in Participants)
                {
                    <tr>
                        <td>@p.GetDisplayName()</td>
                        <td>@p.GetDisplayEmail()</td>
                        <td>
                            @if (p.IsAnonymous)
                            {
                                <span class="badge bg-secondary">Anonymous</span>
                                @if (p.EmailConfirmed)
                                {
                                    <span class="badge bg-success">âœ“ Email</span>
                                }
                            }
                            else
                            {
                                <span class="badge bg-primary">Logged-in</span>
                            }
                        </td>
                        <td>
                            @if (p.Status == ParticipantStatus.Confirmed)
                            {
                                <span class="badge bg-success">Confirmed</span>
                            }
                            else if (p.Status == ParticipantStatus.Waitlisted)
                            {
                                <span class="badge bg-warning">Waitlisted</span>
                            }
                            else if (p.Status == ParticipantStatus.PendingEmail)
                            {
                                <span class="badge bg-info">Pending Email</span>
                            }
                            else if (p.Status == ParticipantStatus.PendingApproval)
                            {
                                <span class="badge bg-secondary">Pending Approval</span>
                            }
                            else if (p.Status == ParticipantStatus.Declined)
                            {
                                <span class="badge bg-danger">Declined</span>
                            }
                            else
                            {
                                <span class="badge bg-light text-dark">@p.Status</span>
                            }
                        </td>
                        <td>@p.CreatedAt.ToLocalTime().ToString("g")</td>
                        <td>
                            @if (p.Status == ParticipantStatus.PendingApproval)
                            {
                                <button class="btn btn-sm btn-success me-1" @onclick="() => ApproveParticipantAsync(p.Id)">Approve</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => DeclineParticipantAsync(p.Id)">Decline</button>
                            }
                            else if (p.Status == ParticipantStatus.Waitlisted)
                            {
                                <button class="btn btn-sm btn-primary me-1" @onclick="() => PromoteParticipantAsync(p.Id)">Promote</button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveParticipantAsync(p.Id)">Remove</button>
                            }
                            else if (p.Status == ParticipantStatus.Confirmed || p.Status == ParticipantStatus.PendingEmail)
                            {
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveParticipantAsync(p.Id)">Remove</button>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

@if (showDeleteDialog)
{
    <div style="position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:1050;display:flex;align-items:center;justify-content:center;">
        <div class="card" style="width:520px;max-width:95%;">
            <div class="card-body">
                <h5 class="card-title">Confirm event deletion</h5>
                <p class="card-text">Type the event title <code>@CurrentEvent?.Title</code> to confirm deletion.</p>
                <input class="form-control mb-3" @bind="typedDeleteText" placeholder="Type title here" />
                <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                    <button class="btn btn-danger" disabled="@(typedDeleteText != CurrentEvent?.Title)" @onclick="ConfirmDeleteAsync">Delete event</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int EventId { get; set; }

    private Event? CurrentEvent { get; set; }
    private List<UserAccount> Organizers { get; set; } = new();
    private List<EventParticipant> Participants { get; set; } = new();
    private ParticipantCounts? ParticipantCounts { get; set; }
    private string? ParticipantFilter { get; set; }
    private bool CanManageEvent { get; set; }
    private bool IsAdmin { get; set; }
    private int CurrentUserId { get; set; }
    private string CurrentUserRole { get; set; } = string.Empty;

    private string? NewOrganizerEmail { get; set; }
    private string? StatusMessage { get; set; }
    private string StatusCss { get; set; } = "alert-info";

    private bool showDeleteDialog = false;
    private string typedDeleteText = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated != true)
        {
            Nav.NavigateTo("/login");
            return;
        }

        var email = user.Identity?.Name;
        var userAccount = await Db.users.FirstOrDefaultAsync(u => u.userEmail == email);
        if (userAccount == null)
        {
            Nav.NavigateTo("/login");
            return;
        }

        CurrentUserId = userAccount.Id;
        CurrentUserRole = userAccount.userRole ?? string.Empty;
        IsAdmin = CurrentUserRole.Contains("Administrator");

        CurrentEvent = await Db.events.FindAsync(EventId);
        if (CurrentEvent == null)
        {
            Nav.NavigateTo("/events");
            return;
        }

        CanManageEvent = await EventSvc.CanUserManageEventAsync(CurrentUserId, EventId, CurrentUserRole);
        
        if (!CanManageEvent)
        {
            return;
        }

        await LoadOrganizersAsync();
        await LoadParticipantsAsync();
    }

    private async Task LoadOrganizersAsync()
    {
        Organizers = await EventSvc.GetOrganizersForEventAsync(EventId);
    }

    private async Task LoadParticipantsAsync()
    {
        ParticipantCounts = await ParticipantSvc.GetParticipantCountsAsync(EventId);
        Participants = await ParticipantSvc.GetParticipantsForEventAsync(EventId, ParticipantFilter);
    }

    private async Task FilterParticipants(string? status)
    {
        ParticipantFilter = status;
        await LoadParticipantsAsync();
    }

    private async Task SaveEventAsync()
    {
        try
        {
            if (CurrentEvent == null) return;

            Db.events.Update(CurrentEvent);
            await Db.SaveChangesAsync();

            StatusMessage = "Event updated successfully.";
            StatusCss = "alert-success";

            // After a successful save, notify participants of updated event details
            await LoadParticipantsAsync();
            var notifyStatuses = new HashSet<string>
            {
                ParticipantStatus.Confirmed,
                ParticipantStatus.Waitlisted,
                ParticipantStatus.PendingApproval,
                ParticipantStatus.PendingEmail // optional: include pending email so they see changes before confirming
            };
            int sent = 0;
            string subject = $"Updated event details: {CurrentEvent.Title}";
            var waitlistText = CurrentEvent.EnableWaitlist ? "Yes" : "No";
            var approvalText = CurrentEvent.RequireOrganizerApproval ? "Yes" : "No";
            var maxText = CurrentEvent.MaxParticipants?.ToString() ?? "Unlimited";
            string body = $@"Hello,

The event you are enlisted in has updated details.

Title: {CurrentEvent.Title}
Description: {CurrentEvent.Description}
Event Window: {CurrentEvent.EventStartDate.ToLocalTime():f} - {CurrentEvent.EventEndDate.ToLocalTime():f}
Enlisting Window: {CurrentEvent.EnlistingStartDate.ToLocalTime():f} - {CurrentEvent.EnlistingEndDate.ToLocalTime():f}
Waitlist Enabled: {waitlistText}
Requires Organizer Approval: {approvalText}
Max Participants: {maxText}

If you can no longer attend you may cancel via the cancellation link you received earlier. If you were waitlisted you will be informed automatically when promoted.

---
Automated notification.";

            foreach (var p in Participants)
            {
                if (!notifyStatuses.Contains(p.Status)) continue;
                string? to = p.IsAnonymous ? (p.EmailConfirmed ? p.Email : null) : p.User?.userEmail;
                if (string.IsNullOrWhiteSpace(to)) continue;
                try
                {
                    EmailService.To = to;
                    EmailService.Subject = subject;
                    EmailService.Body = body;
                    EmailService.SendEmail();
                    sent++;
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed sending update to {to}: {ex.Message}");
                }
            }
            if (sent > 0)
            {
                StatusMessage += $" Notification email sent to {sent} participant(s).";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            StatusMessage = "Error saving event.";
            StatusCss = "alert-danger";
        }
    }

    private async Task AddOrganizerAsync()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(NewOrganizerEmail))
            {
                StatusMessage = "Please enter an email address.";
                StatusCss = "alert-warning";
                return;
            }

            var (success, message) = await EventSvc.AddOrganizerByEmailAsync(EventId, NewOrganizerEmail);
            
            if (success)
            {
                StatusMessage = message;
                StatusCss = "alert-success";
                NewOrganizerEmail = string.Empty;
                await LoadOrganizersAsync();
            }
            else
            {
                StatusMessage = message;
                StatusCss = "alert-warning";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            StatusMessage = "Error adding organizer.";
            StatusCss = "alert-danger";
        }
    }

    private async Task RemoveOrganizerAsync(int userId)
    {
        try
        {
            if (userId == CurrentUserId)
            {
                StatusMessage = "You cannot remove yourself as organizer.";
                StatusCss = "alert-warning";
                return;
            }

            var success = await EventSvc.RemoveOrganizerAsync(EventId, userId);
            
            if (success)
            {
                StatusMessage = "Organizer removed.";
                StatusCss = "alert-success";
                await LoadOrganizersAsync();
            }
            else
            {
                StatusMessage = "Organizer not found.";
                StatusCss = "alert-warning";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            StatusMessage = "Error removing organizer.";
            StatusCss = "alert-danger";
        }
    }

    private void PromptDeleteEvent()
    {
        typedDeleteText = string.Empty;
        showDeleteDialog = true;
    }

    private void CancelDelete()
    {
        showDeleteDialog = false;
        typedDeleteText = string.Empty;
    }

    private async Task ConfirmDeleteAsync()
    {
        try
        {
            if (CurrentEvent == null || typedDeleteText != CurrentEvent.Title)
                return;

            Db.events.Remove(CurrentEvent);
            await Db.SaveChangesAsync();

            Nav.NavigateTo("/events");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            StatusMessage = "Error deleting event.";
            StatusCss = "alert-danger";
            showDeleteDialog = false;
        }
    }

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
            StatusMessage = "Link copied to clipboard!";
            StatusCss = "alert-success";
        }
        catch
        {
            StatusMessage = "Could not copy to clipboard. Please copy manually.";
            StatusCss = "alert-warning";
        }
    }

    private async Task ApproveParticipantAsync(int participantId)
    {
        try
        {
            var success = await ParticipantSvc.ApproveParticipantAsync(participantId);
            if (success)
            {
                StatusMessage = "Participant approved.";
                StatusCss = "alert-success";
                await LoadParticipantsAsync();
            }
            else
            {
                StatusMessage = "Could not approve participant.";
                StatusCss = "alert-warning";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            StatusMessage = "Error approving participant.";
            StatusCss = "alert-danger";
        }
    }

    private async Task DeclineParticipantAsync(int participantId)
    {
        try
        {
            var success = await ParticipantSvc.DeclineParticipantAsync(participantId);
            if (success)
            {
                StatusMessage = "Participant declined.";
                StatusCss = "alert-success";
                await LoadParticipantsAsync();
            }
            else
            {
                StatusMessage = "Could not decline participant.";
                StatusCss = "alert-warning";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            StatusMessage = "Error declining participant.";
            StatusCss = "alert-danger";
        }
    }

    private async Task PromoteParticipantAsync(int participantId)
    {
        try
        {
            // Check if there's capacity
            if (CurrentEvent?.MaxParticipants.HasValue == true &&
                ParticipantCounts != null &&
                ParticipantCounts.Confirmed >= CurrentEvent.MaxParticipants.Value)
            {
                StatusMessage = "Event is at capacity. Cannot promote.";
                StatusCss = "alert-warning";
                return;
            }

            // Manually promote specific participant
            var participant = Participants.FirstOrDefault(p => p.Id == participantId);
            if (participant == null)
            {
                StatusMessage = "Participant not found.";
                StatusCss = "alert-warning";
                return;
            }

            participant.Status = ParticipantStatus.Confirmed;
            Db.eventParticipants.Update(participant);
            await Db.SaveChangesAsync();

            StatusMessage = "Participant promoted to confirmed.";
            StatusCss = "alert-success";
            await LoadParticipantsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            StatusMessage = "Error promoting participant.";
            StatusCss = "alert-danger";
        }
    }

    private async Task RemoveParticipantAsync(int participantId)
    {
        try
        {
            var success = await ParticipantSvc.RemoveParticipantAsync(participantId);
            if (success)
            {
                StatusMessage = "Participant removed.";
                StatusCss = "alert-success";
                await LoadParticipantsAsync();
            }
            else
            {
                StatusMessage = "Could not remove participant.";
                StatusCss = "alert-warning";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            StatusMessage = "Error removing participant.";
            StatusCss = "alert-danger";
        }
    }
}
