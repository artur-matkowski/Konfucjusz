@page "/e/{Slug}/stream"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext Db
@inject ParticipantService ParticipantSvc
@inject NavigationManager Nav
@inject IJSRuntime JS

<h3>Live Audio Stream</h3>

@if (Loading)
{
    <p>Loading stream...</p>
}
else if (EventEntity == null)
{
    <div class="alert alert-danger">Event not found.</div>
}
else
{
    <div class="mb-3">
        <strong>@EventEntity.Title</strong><br />
        <small>@EventEntity.EventStartDate.ToLocalTime():f - @EventEntity.EventEndDate.ToLocalTime():f</small>
    </div>

    @if (!Joined)
    {
        <button class="btn btn-primary" @onclick="JoinStreamAsync" disabled="@JoinInProgress">@(JoinInProgress ? "Joining..." : "Join Stream")</button>
    }
    else
    {
        <div class="alert alert-success p-2">Connected. Audio should begin shortly. Keep this tab active.</div>
        <button class="btn btn-outline-secondary" @onclick="LeaveStreamAsync">Leave Stream</button>
    }

    <div class="mt-4">
        <h6>Status</h6>
        <p>@StatusMessage</p>
    </div>

    @if (EventEntity != null)
    {
        <div class="mt-3">
            <a href="/e/@EventEntity.Slug/recordings" class="btn btn-outline-secondary btn-sm">View Recordings</a>
        </div>
    }
}

@code {
    [Parameter] public string Slug { get; set; } = string.Empty;
    [SupplyParameterFromQuery] public string? Token { get; set; }

    private Event? EventEntity;
    private bool Loading = true;
    private bool Joined = false;
    private bool JoinInProgress = false;
    private string StatusMessage = "Idle";

    protected override async Task OnInitializedAsync()
    {
        EventEntity = await Db.events.FirstOrDefaultAsync(e => e.Slug == Slug);
        Loading = false;
    }

    private async Task JoinStreamAsync()
    {
        if (EventEntity == null) return;
        JoinInProgress = true;
        StatusMessage = "Connecting...";
        try
        {
            await JS.InvokeVoidAsync("konfAudio.startListening", "/hubs/audio", EventEntity.Id, EventEntity.Slug, Token);
            Joined = true;
            StatusMessage = "Listening";
        }
        catch (Exception ex)
        {
            StatusMessage = "Failed to join: " + ex.Message;
        }
        finally
        {
            JoinInProgress = false;
        }
    }

    private async Task LeaveStreamAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("konfAudio.stopListening");
        }
        catch {}
        Joined = false;
        StatusMessage = "Disconnected";
    }
}
