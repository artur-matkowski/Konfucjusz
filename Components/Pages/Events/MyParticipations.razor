@page "/my-events"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@attribute [Authorize(Roles = "User,Administrator,Organizer")]
@inject ApplicationDbContext DbContext
@inject ParticipantService ParticipantService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>My Events</PageTitle>

<h3>My Events</h3>

@if (loading)
{
    <div class="mt-4">
        <p>Loading your events...</p>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger mt-4">
        @errorMessage
    </div>
}
else if (!participations.Any())
{
    <div class="alert alert-info mt-4">
        <h5>No Events Yet</h5>
        <p>You haven't enrolled in any events. When you enlist for events, they will appear here.</p>
    </div>
}
else
{
    <div class="mt-4">
        <p class="text-muted">Events you're participating in or have participated in.</p>
        
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mt-2">
            @foreach (var participation in participations)
            {
                var evt = participation.Event;
                var now = DateTime.UtcNow;
                var isUpcoming = evt.EventStartDate > now;
                var isOngoing = evt.EventStartDate <= now && evt.EventEndDate >= now;
                var isPast = evt.EventEndDate < now;
                
                <div class="col">
                    <div class="card h-100 @GetCardBorderClass(participation.Status)">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong>@evt.Title</strong>
                            @if (isOngoing)
                            {
                                <span class="badge bg-success">Live Now</span>
                            }
                            else if (isUpcoming)
                            {
                                <span class="badge bg-info">Upcoming</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Past</span>
                            }
                        </div>
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">
                                <span class="badge @GetStatusBadgeClass(participation.Status)">
                                    @GetStatusDisplayText(participation.Status)
                                </span>
                            </h6>
                            
                            <p class="card-text small">@evt.Description</p>
                            
                            <hr />
                            
                            <p class="small mb-1">
                                <strong>Start:</strong> @evt.EventStartDate.ToLocalTime().ToString("f")
                            </p>
                            <p class="small mb-1">
                                <strong>End:</strong> @evt.EventEndDate.ToLocalTime().ToString("f")
                            </p>
                            
                            @if (participation.Status == ParticipantStatus.Waitlisted)
                            {
                                <div class="alert alert-warning p-2 mt-2 small">
                                    You're on the waitlist. We'll notify you if a spot opens up.
                                </div>
                            }
                            else if (participation.Status == ParticipantStatus.PendingApproval)
                            {
                                <div class="alert alert-info p-2 mt-2 small">
                                    Your participation is pending organizer approval.
                                </div>
                            }
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-grid gap-2">
                                @if (participation.Status == ParticipantStatus.Confirmed || participation.Status == ParticipantStatus.Waitlisted)
                                {
                                    @if (isOngoing || isUpcoming)
                                    {
                                        <button class="btn btn-primary btn-sm" @onclick="() => GoToStream(evt.Slug)">
                                            ðŸŽ§ Join Stream
                                        </button>
                                    }
                                    
                                    @if (isPast)
                                    {
                                        <button class="btn btn-outline-secondary btn-sm" @onclick="() => GoToRecordings(evt.Slug)">
                                            ðŸ“¼ View Recordings
                                        </button>
                                    }
                                    
                                    <button class="btn btn-outline-danger btn-sm" @onclick="() => ShowCancelConfirmation(participation, evt)">
                                        Cancel Participation
                                    </button>
                                }
                                else if (participation.Status == ParticipantStatus.PendingApproval)
                                {
                                    <button class="btn btn-outline-danger btn-sm" @onclick="() => ShowCancelConfirmation(participation, evt)">
                                        Withdraw Request
                                    </button>
                                }
                                else if (participation.Status == ParticipantStatus.Cancelled)
                                {
                                    <span class="text-muted small">You cancelled your participation</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

@if (showCancelModal && selectedParticipation != null && selectedEvent != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Cancellation</h5>
                    <button type="button" class="btn-close" @onclick="HideCancelConfirmation"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to cancel your participation in:</p>
                    <p class="fw-bold">@selectedEvent.Title</p>
                    <p class="small text-muted">@selectedEvent.EventStartDate.ToLocalTime().ToString("f")</p>
                    
                    @if (selectedParticipation.IsAnonymous)
                    {
                        <div class="alert alert-warning">
                            <strong>Warning:</strong> Your data will be permanently deleted.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideCancelConfirmation">Keep My Spot</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmCancellation" disabled="@cancelling">
                        @(cancelling ? "Cancelling..." : "Yes, Cancel")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<EventParticipantWithEvent> participations = new();
    private bool loading = true;
    private string? errorMessage;
    private int? currentUserId;
    private string? currentUserEmail;
    
    private bool showCancelModal = false;
    private bool cancelling = false;
    private EventParticipant? selectedParticipation;
    private Event? selectedEvent;
    
    private class EventParticipantWithEvent
    {
        public EventParticipant Participant { get; set; } = null!;
        public Event Event { get; set; } = null!;
        public string Status => Participant.Status ?? "Unknown";
    }

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("[MyParticipations] Initializing...");
        loading = true;
        
        try
        {
            // Get current user
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user?.Identity?.IsAuthenticated != true)
            {
                Console.WriteLine("[MyParticipations] User not authenticated");
                errorMessage = "You must be logged in to view your events.";
                loading = false;
                return;
            }
            
            // Get email from Name claim (same pattern as other pages)
            var emailClaim = user.FindFirst(ClaimTypes.Email) 
                          ?? user.FindFirst("email") 
                          ?? user.FindFirst("preferred_username")
                          ?? user.FindFirst(ClaimTypes.Name);
            
            if (emailClaim != null)
            {
                currentUserEmail = emailClaim.Value;
                Console.WriteLine($"[MyParticipations] Email found: {currentUserEmail}");
                
                // Look up user ID from database
                var userAccount = await DbContext.users.FirstOrDefaultAsync(u => u.userEmail == currentUserEmail);
                if (userAccount != null)
                {
                    currentUserId = userAccount.Id;
                    Console.WriteLine($"[MyParticipations] User ID resolved: {currentUserId}");
                }
                else
                {
                    Console.WriteLine($"[MyParticipations] ERROR: No user found with email: {currentUserEmail}");
                }
            }
            else
            {
                Console.WriteLine("[MyParticipations] ERROR: No email claim found");
            }
            
            if (currentUserId == null)
            {
                errorMessage = "Unable to identify your account. Please try logging out and back in.";
                loading = false;
                return;
            }
            
            // Load participations
            await LoadParticipationsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MyParticipations] Exception: {ex.Message}");
            errorMessage = $"Error loading events: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadParticipationsAsync()
    {
        Console.WriteLine($"[MyParticipations] Loading participations for user {currentUserId}...");
        
        // Get all participations for this user, including the event details
        var results = await DbContext.eventParticipants
            .Where(p => p.UserId == currentUserId)
            .Include(p => p.Event)
            .OrderByDescending(p => p.Event!.EventStartDate)
            .Select(p => new EventParticipantWithEvent
            {
                Participant = p,
                Event = p.Event!
            })
            .ToListAsync();
        
        participations = results;
        Console.WriteLine($"[MyParticipations] Found {participations.Count} participations");
    }

    private void GoToStream(string? slug)
    {
        if (string.IsNullOrEmpty(slug))
        {
            Console.WriteLine("[MyParticipations] Cannot navigate to stream: slug is empty");
            return;
        }
        
        Console.WriteLine($"[MyParticipations] Navigating to stream: /e/{slug}/stream");
        Navigation.NavigateTo($"/e/{slug}/stream");
    }

    private void GoToRecordings(string? slug)
    {
        if (string.IsNullOrEmpty(slug))
        {
            Console.WriteLine("[MyParticipations] Cannot navigate to recordings: slug is empty");
            return;
        }
        
        Console.WriteLine($"[MyParticipations] Navigating to recordings: /e/{slug}/recordings");
        Navigation.NavigateTo($"/e/{slug}/recordings");
    }

    private void ShowCancelConfirmation(EventParticipantWithEvent participation, Event evt)
    {
        selectedParticipation = participation.Participant;
        selectedEvent = evt;
        showCancelModal = true;
    }

    private void HideCancelConfirmation()
    {
        showCancelModal = false;
        selectedParticipation = null;
        selectedEvent = null;
    }

    private async Task ConfirmCancellation()
    {
        if (selectedParticipation == null || selectedEvent == null) return;
        
        cancelling = true;
        
        try
        {
            Console.WriteLine($"[MyParticipations] Cancelling participation {selectedParticipation.Id} for event {selectedEvent.Id}");
            var success = await ParticipantService.CancelParticipationAsync(selectedParticipation.Id, selectedEvent.Id);
            
            if (success)
            {
                Console.WriteLine("[MyParticipations] Cancellation successful");
                // Reload participations to reflect changes
                await LoadParticipationsAsync();
            }
            else
            {
                Console.WriteLine("[MyParticipations] Cancellation failed");
                errorMessage = "Failed to cancel participation. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MyParticipations] Exception during cancellation: {ex.Message}");
            errorMessage = $"Error cancelling participation: {ex.Message}";
        }
        finally
        {
            cancelling = false;
            HideCancelConfirmation();
        }
    }

    private string GetCardBorderClass(string status)
    {
        return status switch
        {
            ParticipantStatus.Confirmed => "border-success",
            ParticipantStatus.Waitlisted => "border-warning",
            ParticipantStatus.PendingApproval => "border-info",
            ParticipantStatus.Cancelled => "border-secondary",
            ParticipantStatus.Removed => "border-danger",
            _ => ""
        };
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            ParticipantStatus.Confirmed => "bg-success",
            ParticipantStatus.Waitlisted => "bg-warning text-dark",
            ParticipantStatus.PendingApproval => "bg-info text-dark",
            ParticipantStatus.Cancelled => "bg-secondary",
            ParticipantStatus.Removed => "bg-danger",
            ParticipantStatus.Declined => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetStatusDisplayText(string status)
    {
        return status switch
        {
            ParticipantStatus.Confirmed => "âœ“ Confirmed",
            ParticipantStatus.Waitlisted => "â³ Waitlisted",
            ParticipantStatus.PendingApproval => "â³ Pending Approval",
            ParticipantStatus.Cancelled => "âœ— Cancelled",
            ParticipantStatus.Removed => "âœ— Removed",
            ParticipantStatus.Declined => "âœ— Declined",
            _ => status
        };
    }
}
